From 82492f5d765b70cc87385fb887008df89fac878e Mon Sep 17 00:00:00 2001
From: Patrick Griffis <tingping@tingping.se>
Date: Fri, 7 Apr 2017 20:57:52 -0400
Subject: [PATCH] i18n: Add data_dirs kwarg to merge_file()

For parity with gettext()

Fixes #1565
---
 mesonbuild/mesonmain.py            |  3 +++
 mesonbuild/modules/i18n.py         | 11 +++++++++--
 mesonbuild/scripts/msgfmthelper.py | 35 +++++++++++++++++++++++++++++++++++
 3 files changed, 47 insertions(+), 2 deletions(-)
 create mode 100644 mesonbuild/scripts/msgfmthelper.py

diff --git a/mesonbuild/mesonmain.py b/mesonbuild/mesonmain.py
index 7e4be7f92..df112b3bf 100644
--- a/mesonbuild/mesonmain.py
+++ b/mesonbuild/mesonmain.py
@@ -222,6 +222,9 @@ def run_script_command(args):
     elif cmdname == 'gtkdoc':
         import mesonbuild.scripts.gtkdochelper as abc
         cmdfunc = abc.run
+    elif cmdname == 'msgfmthelper':
+        import mesonbuild.scripts.msgfmthelper as abc
+        cmdfunc = abc.run
     elif cmdname == 'regencheck':
         import mesonbuild.scripts.regen_checker as abc
         cmdfunc = abc.run
diff --git a/mesonbuild/modules/i18n.py b/mesonbuild/modules/i18n.py
index 5738cb3c4..78112fc80 100644
--- a/mesonbuild/modules/i18n.py
+++ b/mesonbuild/modules/i18n.py
@@ -60,8 +60,15 @@ def merge_file(self, state, args, kwargs):
         if file_type not in VALID_TYPES:
             raise MesonException('i18n: "{}" is not a valid type {}'.format(file_type, VALID_TYPES))
 
-        kwargs['command'] = ['msgfmt', '--' + file_type,
-                             '--template', '@INPUT@', '-d', podir, '-o', '@OUTPUT@']
+        datadirs = mesonlib.stringlistify(kwargs.pop('data_dirs', []))
+        datadirs = '--datadirs=' + ':'.join(datadirs) if datadirs else None
+
+        command = [state.environment.get_build_command(), '--internal', 'msgfmthelper',
+                   '@INPUT@', '@OUTPUT@', file_type, podir]
+        if datadirs:
+            command.append(datadirs)
+
+        kwargs['command'] = command
         ct = build.CustomTarget(kwargs['output'] + '_merge', state.subdir, kwargs)
         return ModuleReturnValue(ct, [ct])
 
diff --git a/mesonbuild/scripts/msgfmthelper.py b/mesonbuild/scripts/msgfmthelper.py
new file mode 100644
index 000000000..d4deb0051
--- /dev/null
+++ b/mesonbuild/scripts/msgfmthelper.py
@@ -0,0 +1,35 @@
+# Copyright 2016 The Meson development team
+
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+
+#     http://www.apache.org/licenses/LICENSE-2.0
+
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+
+import argparse
+import subprocess
+import os
+
+parser = argparse.ArgumentParser()
+parser.add_argument('input')
+parser.add_argument('output')
+parser.add_argument('type')
+parser.add_argument('podir')
+parser.add_argument('--datadirs', default='')
+
+
+def run(args):
+    options = parser.parse_args(args)
+    env = None
+    if options.datadirs:
+        env = os.environ.copy()
+        env.update({'GETTEXTDATADIRS': options.datadirs})
+    return subprocess.call(['msgfmt', '--' + options.type, '-d', options.podir,
+                            '--template', options.input,  '-o', options.output],
+                           env=env)
