diff --git a/src/script.c b/src/script.c
index 1863a661..74aef1b1 100644
--- a/src/script.c
+++ b/src/script.c
@@ -213,10 +213,11 @@ make_env(const struct interface *ifp, const char *reason)
 	if (tmpfd == -1)
 		goto eexit;
 	unlink(tmpfile);
-	fp = fopen(tmpfile, "w+");
-	close(tmpfd);
-	if (fp == NULL)
+	fp = fdopen(tmpfd, "w+");
+	if (fp == NULL) {
+		close(tmpfd);
 		goto eexit;
+	}
 #endif
 
 #ifdef INET
